#%Module

# =====================================================================
# Generated by SIMPLE-MOD
# Developer: Jason Li (jasonli3@lsu.edu)
# Description: 
#       1) This module template is compatible with:
#            - Environment Modules >= 4.5.2. 
#               See https://github.com/cea-hpc/modules
#            - Lmod >= 8.7.34. 
#               See https://github.com/TACC/Lmod
#          May not be compatible with different module systems.
#       2) This template generates wrapper scripts in users' 
#          environment, and works with MPI-enabled software packages.
# =====================================================================

# ---------------------------------------------------------------------
# Wrapper scripts path (Customize me)
# ---------------------------------------------------------------------

set WRAPPER_PATH /home/$env(USER)/.local/bin/modules

# ---------------------------------------------------------------------
# Software specific information
# ---------------------------------------------------------------------

# Module information
module-whatis Name: paraview
module-whatis Version: 5.12.1
module-whatis Description: ParaView is an open-source, multi-platform data analysis and visualization application.

# Singularity options
set SINGULARITY_IMAGE "/project/containers/images/paraviewweb-5.12.1.sif"
set SINGULARITY_BINDPATHS "/work,/project,/usr/local/packages,/var/scratch,"
set SINGULARITY_FLAGS " "

# Conflicts
conflict paraview 

# List of commands to overwrite
set CMDS {
pvserver
}

# Set environment varialbles


# ---------------------------------------------------------------------
# Module key setup
# ---------------------------------------------------------------------

# Combine Singularity exec command
set SINGULARITY_EXEC "singularity exec -B $SINGULARITY_BINDPATHS $SINGULARITY_FLAGS --pwd \$PWD $SINGULARITY_IMAGE"

# Set wrapper directory
file mkdir $WRAPPER_PATH/paraview/5.12.1
prepend-path PATH $WRAPPER_PATH/paraview/5.12.1

# Create wrappers when the module is loaded
if { [ module-info mode load ] } {

    # If it is csh type shell
    if { [module-info shelltype] == "csh" } {
    
        # Create wrappers for each command
        foreach cmd $CMDS {
            puts "echo '#\\!/bin/bash' > $WRAPPER_PATH/paraview/5.12.1/$cmd;"
            puts "echo '$SINGULARITY_EXEC $cmd \"$@\"' >> $WRAPPER_PATH/paraview/5.12.1/$cmd;"
            puts "chmod u+x $WRAPPER_PATH/paraview/5.12.1/$cmd;"
        }
        
        # Refresh cache (only for csh type shell)
        puts "rehash;"
        
    # If it is sh type shell
    } elseif { [module-info shelltype] == "sh" } {
    
        # Create wrappers for each command
        foreach cmd $CMDS {
            puts "echo '#!/bin/bash' > $WRAPPER_PATH/paraview/5.12.1/$cmd;"
            puts "echo '$SINGULARITY_EXEC $cmd \"$@\"' >> $WRAPPER_PATH/paraview/5.12.1/$cmd;"
            puts "chmod u+x $WRAPPER_PATH/paraview/5.12.1/$cmd;"
        }
        
    }
}

# Currently, wrappers will not be deleted to avoid unwanted issues.

# Help information
proc ModulesHelp {} {
    global CMDS
    puts stderr "

\[ Instructions \]

You are recommended to use ParaViewWeb app on Open OnDemand for fast rendering if possible. 
If you need client-server mode, please follow below instructions:

1. Download \[ ParaView 5.12.1 \] for your OS. You *MUST* use the version matching the ParaView version on cluster!

https://www.paraview.org/download/

2. Start a job on cluster. ParaView server can only be launched from computing nodes, e.g.:

salloc -A your_allocation_name -t 12:00:00 -N1 -p workq

3. Load ParaView module and launch ParaView server:

module load paraview/5.12.1
srun -n8 pvserver --server-port=11111

4. Establish an SSH tunnel. Run one of the following commands from your *local* terminal ('XXX' is the computing node number):

ssh -L11111:smicXXX:11111 -N your_user_name@smic.hpc.lsu.edu    # SMIC
ssh -L11111:dbXXX:11111 -N your_user_name@db1.hpc.lsu.edu       # Deep Bayou
ssh -L11111:mikeXXX:11111 -N your_user_name@mike.hpc.lsu.edu    # Supermike 3
ssh -L11111:qbcXXX:11111 -N your_user_name@qbc.loni.org         # QB-3
ssh -L11111:qbcXXX:11111 -N your_user_name@qbd.loni.org         # QB-4

After entering your password and 2FA token, terminal will hang. Leave it open.

5. Start ParaView 5.12.1 on your local computer. 

Add server: Go to 'File > Connect > Add Server'. Keep everything default, which connects to 'localhost:11111'. 

Connect to the added server.

"
}
if { [ module-info mode load ] } {
    ModulesHelp
}