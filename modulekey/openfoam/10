#%Module

# =====================================================================
# Generated by SIMPLE-MOD
# Developer: Jason Li (jasonli3@lsu.edu)
# Description: 
#       1) This module template is compatible with:
#            - Environment Modules >= 4.5.2. 
#               See https://github.com/cea-hpc/modules
#            - Lmod >= 8.7.34. 
#               See https://github.com/TACC/Lmod
#          May not be compatible with different module systems.
#       2) This template generates wrapper scripts in users' 
#          environment, and works with MPI-enabled software packages.
# =====================================================================

# ---------------------------------------------------------------------
# Wrapper scripts path (Customize me)
# ---------------------------------------------------------------------

set WRAPPER_PATH /home/$env(USER)/.local/bin/modules

# ---------------------------------------------------------------------
# Software specific information
# ---------------------------------------------------------------------

# Module information
module-whatis Name: openfoam
module-whatis Version: 10
module-whatis Description: OpenFOAM is free, open source software for CFD from the OpenFOAM Foundation.

# Singularity options
set SINGULARITY_IMAGE "/home/admin/singularity/openfoam10-openmpi.4.0.3-pmi2.sif"
set SINGULARITY_BINDPATHS "/work,/project,/usr/local/packages,/var/scratch,"
set SINGULARITY_FLAGS " "

# Conflicts
conflict openfoam paraview

# List of commands to overwrite
set CMDS {
DPMFoam MPPICFoam XiEngineFoam buoyantPimpleFoam buoyantReactingParticleFoam buoyantSimpleFoam coalChemistryFoam coldEngineFoam compressibleInterFilmFoam engineFoam fireFoam foamCleanCase foamCleanPath foamCleanTutorials foamCloneCase foamCreateVideo foamEtcFile foamExec foamGet foamInfo foamJob foamLog foamMonitor foamNew foamNewApp foamNewBC foamNewFunctionObject foamNewSource foamNewTemplate foamRunTutorials foamSearch foamSequenceVTKFiles foamTags icoUncoupledKinematicParcelFoam interPhaseChangeFoam mergeOrSplitBaffles moveDynamicMesh mpirunDebug org-html org-latex org-pdflatex paraFoam reactingMultiphaseEulerFoam reactingParcelFoam reactingParticleFoam reactingTwoPhaseEulerFoam rhoReactingBuoyantFoam rhoReactingFoam simpleReactingParcelFoam simpleReactingParticleFoam sprayFoam surfaceFeatureExtract tools twoPhaseEulerFoam uncoupledKinematicParcelFoam 

PDRFoam PDRMesh SRFPimpleFoam SRFSimpleFoam XiFoam adiabaticFlameT adjointShapeOptimisationFoam ansysToFoam applyBoundaryLayer attachMesh autoPatch autoRefineMesh blockMesh boundaryFoam boxTurb buoyantFoam buoyantReactingFoam cavitatingFoam cfx4ToFoam changeDictionary checkMesh chemFoam chemkinToFoam chtMultiRegionFoam collapseEdges combinePatchFaces compressibleInterFoam compressibleMultiphaseInterFoam createBaffles createExternalCoupledPatchGeometry createNonConformalCouples createPatch datToFoam decomposePar deformedGeom denseParticleFoam dnsFoam driftFluxFoam dsmcFoam dsmcInitialise electrostaticFoam engineCompRatio engineSwirl equilibriumCO equilibriumFlameT extrude2DMesh extrudeMesh extrudeToRegionMesh faceAgglomerate financialFoam flattenMesh fluent3DMeshToFoam fluentMeshToFoam foamDataToFluent foamDictionary foamFormatConvert foamListTimes foamMeshToFluent foamSetupCHT foamToEnsight foamToEnsightParts foamToGMV foamToStarMesh foamToSurface foamToTetDualMesh foamToVTK foamyHexMesh foamyQuadMesh gambitToFoam gmshToFoam icoFoam ideasUnvToFoam insideCells interFoam interMixingFoam kivaToFoam laplacianFoam magneticFoam mapFields mapFieldsPar mdEquilibrationFoam mdFoam mdInitialise mergeBaffles mergeMeshes mhdFoam mirrorMesh mixtureAdiabaticFlameT modifyMesh moveMesh mshToFoam multiphaseEulerFoam multiphaseInterFoam netgenNeutralToFoam noise objToVTK orientFaceZone particleFoam particleTracks patchSummary pdfPlot pimpleFoam pisoFoam plot3dToFoam polyDualMesh porousSimpleFoam postProcess potentialFoam potentialFreeSurfaceFoam reactingFoam reconstructPar reconstructParMesh redistributePar refineHexMesh refineMesh refineWallLayer refinementLevel removeFaces renumberMesh rhoCentralFoam rhoParticleFoam rhoPimpleFoam rhoPorousSimpleFoam rhoSimpleFoam rotateMesh sammToFoam scalarTransportFoam selectCells setAtmBoundaryLayer setFields setWaves setsToZones shallowWaterFoam simpleFoam singleCellMesh smapToFoam snappyHexMesh solidDisplacementFoam solidEquilibriumDisplacementFoam splitBaffles splitCells splitMesh splitMeshRegions star3ToFoam star4ToFoam steadyParticleTracks stitchMesh subsetMesh surfaceAdd surfaceAutoPatch surfaceBooleanFeatures surfaceCheck surfaceClean surfaceCoarsen surfaceConvert surfaceFeatureConvert surfaceFeatures surfaceFind surfaceHookUp surfaceInertia surfaceLambdaMuSmooth surfaceMeshConvert surfaceMeshConvertTesting surfaceMeshExport surfaceMeshImport surfaceMeshInfo surfaceMeshTriangulate surfaceOrient surfacePointMerge surfaceRedistributePar surfaceRefineRedGreen surfaceSplitByPatch surfaceSplitByTopology surfaceSplitNonManifolds surfaceSubset surfaceToPatch surfaceTransformPoints temporalInterpolate tetgenToFoam thermoFoam topoSet transformPoints twoLiquidMixingFoam viewFactorsGen vtkUnstructuredToFoam writeMeshObj zipUpMesh 

paraview paraview-config paraview.conf pvbatch pvdataserver pvpython pvrenderserver pvserver smTestDriver-pv5.10 vtkParseJava-pv5.10 vtkProbeOpenGLVersion-pv5.10 vtkProcessXML-pv5.10 vtkWrapClientServer-pv5.10 vtkWrapHierarchy-pv5.10 vtkWrapJava-pv5.10 vtkWrapPython-pv5.10 vtkWrapPythonInit-pv5.10 vtkprotoc-pv5.10 

wclean wcleanLnIncludeAll wcleanPlatform wdep wmake wmakeCheckPwd wmakeCollect wmakeFilesAndOptions wmakeLnInclude wmakeLnIncludeAll wmakePrintBuild wmakeScheduler wmakeSchedulerUptime wrmdep wrmo 
}

# Set environment varialbles


# ---------------------------------------------------------------------
# Module key setup
# ---------------------------------------------------------------------

# Combine Singularity exec command
set SINGULARITY_EXEC "singularity exec -B $SINGULARITY_BINDPATHS $SINGULARITY_FLAGS --pwd \$PWD $SINGULARITY_IMAGE"

# Set wrapper directory
file mkdir $WRAPPER_PATH/openfoam/10
prepend-path PATH $WRAPPER_PATH/openfoam/10

# Create wrappers when the module is loaded
if { [ module-info mode load ] } {

    # If it is csh type shell
    if { [module-info shelltype] == "csh" } {
    
        # Create wrappers for each command
        foreach cmd $CMDS {
            puts "echo '#\\!/bin/bash' > $WRAPPER_PATH/openfoam/10/$cmd;"
            puts "echo '$SINGULARITY_EXEC $cmd $@' >> $WRAPPER_PATH/openfoam/10/$cmd;"
            puts "chmod u+x $WRAPPER_PATH/openfoam/10/$cmd;"
        }
        
        # Refresh cache (only for csh type shell)
        puts "rehash;"
        
    # If it is sh type shell
    } elseif { [module-info shelltype] == "sh" } {
    
        # Create wrappers for each command
        foreach cmd $CMDS {
            puts "echo '#!/bin/bash' > $WRAPPER_PATH/openfoam/10/$cmd;"
            puts "echo '$SINGULARITY_EXEC $cmd $@' >> $WRAPPER_PATH/openfoam/10/$cmd;"
            puts "chmod u+x $WRAPPER_PATH/openfoam/10/$cmd;"
        }
        
    }
}

# Currently, wrappers will not be deleted to avoid unwanted issues.

# Help information
proc ModulesHelp {} {
    global CMDS
    puts stderr "

\[ Help information \]

1. This module only works on computing nodes (not available on head nodes). Make sure you start a job!

2. Below executables are available:
$CMDS"
}
if { [ module-info mode load ] } {
    ModulesHelp
}
